Azure Virtual Network Notes
Isolation and segmentation

You can implement multiple virtual networks within each Azure subscription and Azure region. Each virtual network is isolated from other virtual networks. For each virtual network you can:




Specify a custom private IP address space using public and private (RFC 1918) addresses. Azure assigns resources in a virtual network a private IP address from the address space that you assign.




Segment the virtual network into one or more subnets and allocate a portion of the virtual network's address space to each subnet.




Use Azure-provided name resolution, or specify your own DNS server, for use by resources in a virtual network.




All resources in a virtual network can communicate outbound to the internet, by default. You can communicate inbound to a resource by assigning a public IP address or a public Load Balancer. You can also use public IP or public Load Balancer to manage your outbound connections.




Communicate between Azure resources

Azure resources communicate securely with each other in one of the following ways:

Through a virtual network: You can deploy VMs, and several other types of Azure resources to a virtual network, such as Azure App Service Environments, the Azure Kubernetes Service (AKS), and Azure Virtual Machine Scale Sets. To view a complete list of Azure resources that you can deploy into a virtual network, see Virtual network service integration.




Through a virtual network service endpoint: Extend your virtual network private address space and the identity of your virtual network to Azure service resources, such as Azure Storage accounts and Azure SQL databases, over a direct connection. Service endpoints allow you to secure your critical Azure service resources to only a virtual network.




Communicate with on-premises resources

You can connect your on-premises computers and networks to a virtual network using any combination of the following options:




Point-to-site virtual private network(VPN): Established between a virtual network and a single computer in your network. Each computer that wants to establish connectivity with a virtual network must configure its connection. This connection type is great if you're just getting started with Azure, or for developers, because it requires little or no changes to your existing network. The communication between your computer and a virtual network is sent through an encrypted tunnel over the internet. To learn more, see Point-to-site VPN.




Site-to-site VPN: Established between your on-premises VPN device and an Azure VPN Gateway that is deployed in a virtual network. This connection type enables any on-premises resource that you authorize to access a virtual network. The communication between your on-premises VPN device and an Azure VPN gateway is sent through an encrypted tunnel over the internet. To learn more, see Site-to-site VPN.

Azure ExpressRoute: Established between your network and Azure, through an ExpressRoute partner. This connection is private. Traffic does not go over the internet.




Filter network traffic

You can filter network traffic between subnets using either or both of the following options:

Security groups: Network security groups and application security groups can contain multiple inbound and outbound security rules that enable you to filter traffic to and from resources by source and destination IP address, port, and protocol.

Network virtual appliances: A network virtual appliance is a VM that performs a network function, such as a firewall, WAN optimization, or other network function.




Route network traffic

Azure routes traffic between subnets, connected virtual networks, on-premises networks, and the Internet, by default. You can implement either or both of the following options to override the default routes Azure creates:




Route tables: You can create custom route tables with routes that control where traffic is routed to for each subnet.




Border gateway protocol(BGP)routes: If you connect your virtual network to your on-premises network using an Azure VPN Gateway or ExpressRoute connection, you can propagate your on-premises BGP routes to your virtual networks.







Quickstart: Create a virtual network using PowerShell

A virtual network lets Azure resources, like virtual machines (VMs), communicate privately with each other, and with the internet. In this quickstart, you learn how to create a virtual network. After creating a virtual network, you deploy two VMs into the virtual network. You then connect to the VMs from the internet, and communicate privately over the virtual network.




Launch Azure Cloud Shell

The Azure Cloud Shell is a free interactive shell that you can use to run the steps in this article. It has common Azure tools preinstalled and configured to use with your account. Just click the Copy to copy the code, paste it into

the Cloud Shell, and then press enter to run it.




If you decide to install and use PowerShell locally instead, this quickstart requires you to use Azure PowerShell module version 1.0.0 or later. To find the installed version, run Get-Module -ListAvailable Az.




Finally, if you're running PowerShell locally, you'll also need to run

Connect-AzAccount. That command creates a connection with Azure.




Create a resource group and a virtual network

There are a handful of steps you have to walk through to get your resource group and virtual network configured.



















Create the resource group

Before you can create a virtual network, you have to create a resource group to host the virtual network. Create a resource group with New-AzResourceGroup.

This example creates a resource group named myResourceGroup in the eastus location:

New-AzResourceGroup -Name myResourceGroup -Location EastUS




Create the virtual network

Create a virtual network with New-AzVirtualNetwork. This example creates a default virtual network named myVirtualNetwork in the EastUS location:




$virtualNetwork = New-AzVirtualNetwork `

-ResourceGroupName myResourceGroup `

-Location EastUS `

-Name myVirtualNetwork `

-AddressPrefix 10.0.0.0/16




Add a subnet

Azure deploys resources to a subnet within a virtual network, so you need to create a subnet. Create a subnet configuration named default with

Add-AzVirtualNetworkSubnetConfig:




$subnetConfig = Add-AzVirtualNetworkSubnetConfig `

-Name default `

-AddressPrefix 10.0.0.0/24 `

-VirtualNetwork $virtualNetwork




Associate the subnet to the virtual network

You can write the subnet configuration to the virtual network with Set-AzVirtualNetwork. This command creates the subnet:




$virtualNetwork | Set-AzVirtualNetwork




Create virtual machines

Create two VMs in the virtual network.

Create the first VM with New-AzVM. When you run the next command, you're prompted for credentials. Enter a user name and password for the VM:




New-AzVm `

-ResourceGroupName "myResourceGroup" `

-Location "East US" `

-VirtualNetworkName "myVirtualNetwork" `

-SubnetName "default" `

-Name "myVm1" `

-AsJob




The -AsJob option creates the VM in the background. You can continue to the next step. When Azure starts creating the VM in the background, you'll get something like this back: Id

--

1

Name

PSJobTypeName State

----

------------- -----

Long Running... AzureLongRun... Running

Create the second VM with this command:

New-AzVm `

-ResourceGroupName "myResourceGroup" `

-VirtualNetworkName "myVirtualNetwork" `

-SubnetName "default" `

-Name "myVm2"




HasMoreData

-----------

True

Location

--------

localhost

Command




New-AzVM




You'll have to create another user and password. Azure takes a few minutes to create the VM.




IMPORTANT

Don't continue with the next step until Azure's finished. You'll know it's done when it returns output to PowerShell.







Connect to a VM from the internet

Use Get-AzPublicIpAddress to return the public IP address of a VM. This example returns the public IP address of the myVm1 VM:




Get-AzPublicIpAddress `

-Name myVm1 `

-ResourceGroupName myResourceGroup `

| Select IpAddress




Open a command prompt on your local computer. Run the public IP address returned from the last step:




mstsc command. Replace <publicIpAddress>




If you've been running these commands from a PowerShell prompt on your local computer, and you're using the Az PowerShell module version 1.0 or later, you can continue in that interface. mstsc /v:<publicIpAddress>




A Remote Desktop Protocol (.rdp) file downloads to your computer and a Remote Desktop opens.

1. If prompted, select Connect.

2. Enter the user name and password you specified when creating the VM.




NOTE

You may need to select More choices > Use a different account, to specify the credentials you entered when you created the VM.

3. Select OK.

4. You may receive a certificate warning. If you do, select Yes or Continue.

Communicate between Vms







To allow myVm2 to ping myVm1 in a later step, enter this command:




New-NetFirewallRule –DisplayName “Allow ICMPv4-In” –Protocol ICMPv4




That command lets ICMP inbound through the Windows firewall.

4. Close the remote desktop connection to myVm1.

5. Repeat the steps in Connect to a VM from the internet. This time, connect to myVm2.

6. From a command prompt on the myVm2 VM, enter ping myvm1




You'll get something like this back:

C:\windows\system32>ping myVm1

Pinging myVm1.e5p2dibbrqtejhq04lqrusvd4g.bx.internal.cloudapp.net [10.0.0.4] with 32 bytes of data:

Reply from 10.0.0.4: bytes=32 time=2ms TTL=128

Reply from 10.0.0.4: bytes=32 time<1ms TTL=128

Reply from 10.0.0.4: bytes=32 time<1ms TTL=128

Reply from 10.0.0.4: bytes=32 time<1ms TTL=128

Ping statistics for 10.0.0.4:

Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),

Approximate round trip times in milli-seconds:

Minimum = 0ms, Maximum = 2ms, Average = 0ms

You receive replies from myVm1, because you allowed ICMP through the Windows firewall on the myVm1 VM in a previous step.




7. Close the remote desktop connection to myVm2.

Clean up resources




When you're done with the virtual network and the VMs, use Remove-AzResourceGroup to remove the resource group and all the resources it has:

Remove-AzResourceGroup -Name myResourceGroup -Force




Create a virtual network using the Azure CLI

A virtual network enables Azure resources, like virtual machines (VMs), to communicate privately with each other, and with the internet. In this quickstart, you learn how to create a virtual network. After creating a virtual network,

you deploy two VMs into the virtual network. You then connect to the VMs from the internet, and communicate privately over the new virtual network.




Create a resource group and a virtual network

Before you can create a virtual network, you have to create a resource group to host the virtual network. Create a resource group with az group create. This example creates a resource group named myResourceGroup in the eastus location:

az group create --name myResourceGroup --location eastus




Create a virtual network with az network vnet create. This example creates a default virtual network named myVirtualNetwork with one subnet named default:




az network vnet create \

--name myVirtualNetwork \

--resource-group myResourceGroup \

--subnet-name default













Create virtual machinesCreate two VMs in the virtual network.

Create a VM with az vm create. If SSH keys don't already exist in a default key location, the command creates them. To use a specific set of keys, use the --ssh-key-value option. The --no-wait option creates the VM in the background, so that you can continue to the next step. This example creates a VM named myVm1:




az vm create \

--resource-group myResourceGroup \

--name myVm1 \

--image UbuntuLTS \

--generate-ssh-keys \

--no-wait




Create the second VM

Since you used the --no-wait option in the previous step, you can go ahead and create the second VM named myVm2.




az vm create \

--resource-group myResourceGroup \

--name myVm2 \

--image UbuntuLTS \

--generate-ssh-keys







Azure CLI output message

The VMs take a few minutes to create. After Azure creates the VMs, the Azure CLI returns output like this:

{

"fqdns": "",

"id": "/subscriptions/00000000-0000-0000-0000-

000000000000/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVm2",

"location": "eastus",

"macAddress": "00-0D-3A-23-9A-49",

"powerState": "VM running",

"privateIpAddress": "10.0.0.5",

"publicIpAddress": "40.68.254.142",

"resourceGroup": "myResourceGroup"

"zones": ""

}




Take note of the publicIpAddress. You will use this address to connect to the VM from the internet in the next step.




Connect to a VM from the internet

In this command, replace <publicIpAddress> with the public IP address of your myVm2 VM:




ssh <publicIpAddress>




Communicate between VMs

To confirm private communication between the myVm2 and myVm1 VMs, enter this command:

ping myVm1 -c 4You'll receive four replies from 10.0.0.4.

Exit the SSH session with the myVm2 VM.




Clean up resources

When no longer needed, you can use az group delete to remove the resource group and all the resources it has:

az group delete --name myResourceGroup --yes










Security groups




You can filter network traffic to and from Azure resources in an Azure virtual network with a network security group. A network security group contains security rules that allow or deny inbound network traffic to, or outbound network traffic from, several types of Azure resources. To learn about which Azure resources can be deployed into a virtual network and have network security groups associated to them, see Virtual network integration for Azure services. For each rule, you can specify source and destination, port, and protocol.




Security rules

A network security group contains zero, or as many rules as desired, within Azure subscription limits. Each rule specifies the following properties:




Name

A unique name within the network security group.




Priority

A number between 100 and 4096. Rules are processed in priority order, with lower numbers processed before higher numbers, because lower numbers have higher priority. Once traffic matches a rule, processing stops. As a result, any rules

that exist with lower priorities (higher numbers) that have the same attributes as rules with higher priorities are not processed.




Source or destination

Any, or an individual IP address, classless inter-domain routing (CIDR) block (10.0.0.0/24, for example), service tag, or application security group. If you specify an address for an Azure resource, specify the private IP address assigned to the resource. Network security groups are processed after Azure translates a public IP address to a private IP address for inbound traffic, and before Azure translates a private IP address to a public IP address for outbound traffic. Specifying a range, a service tag, or application security group, enables you to create fewer security rules. The ability to specify multiple individual IP addresses and ranges (you cannot specify multiple service tags or application groups) in a rule is referred to as augmented security rules. Augmented security rules can only be created in network security groups created through the Resource Manager deployment model. You cannot specify multiple IP addresses and IP address ranges in network security groups created through the classic deployment model.




Protocol

TCP, UDP, or Any, which includes (but not limited to) TCP, UDP, and ICMP. You cannot specify ICMP alone, so if you require ICMP, use Any.




Direction

Whether the rule applies to inbound, or outbound traffic.




Port range You can specify an individual or range of ports. For example,

you could specify 80 or 10000-10005. Specifying ranges enables you to create fewer security rules.




Augmented security rules can only be created in network security groups created through the Resource Manager deployment model. You cannot specify multiple ports or port ranges in the same security rule in network security groups created through the classic deployment model.




Action

Allow or deny




Network security group security rules are evaluated by priority using the 5-tuple information (source, source port, destination, destination port, and protocol) to allow or deny the traffic. A flow record is created for existing connections. Communication is allowed or denied based on the connection state of the flow record. The flow record allows a network security group to be stateful. If you specify an outbound security rule to any address over port 80, for example, it's not necessary to specify an inbound security rule for the response to the outbound

traffic. You only need to specify an inbound security rule if communication is initiated externally. The opposite is also true. If inbound traffic is allowed over a port, it's not necessary to specify an outbound security rule to respond to traffic over the port. Existing connections may not be interrupted when you remove a security rule that enabled the flow. Traffic flows are interrupted when connections are stopped and no traffic is flowing in either direction, for at least a few minutes.




Service tags

A service tag represents a group of IP address prefixes to help minimize complexity for security rule creation. You cannot create your own service tag, nor specify which IP addresses are included within a tag. Microsoft manages the address prefixes encompassed by the service tag, and automatically updates the service tag as addresses change. You can use service tags in place of specific IP addresses when creating security rules. You can download and integrate with an on premises firewall the list of service tags with prefix details on the following weekly publications for Azure Public, US government, China, and Germany clouds.




The following service tags are available for use in security rule definition. Their names vary slightly between Azure deployment models.




VirtualNetwork (Resource Manager)(VIRTUAL_NETWORK for classic): This tag includes the virtual network address space (all CIDR ranges defined for the virtual network), all connected on-premises address spaces, and peered virtual networks or virtual network connected to a virtual network gateway.




AzureLoadBalancer (Resource Manager)(AZURE_LOADBALANCER for classic): This tag denotes Azure's infrastructure load balancer. The tag translates to the Virtual IP address of the host (168.63.129.16) where Azure's health probes originate. If you are not using the Azure load balancer, you can override this rule.




Internet (Resource Manager)(INTERNET for classic): This tag denotes the IP address space that is outside the virtual network and reachable by the public Internet. The address range includes the Azure owned public IP address space.




AzureCloud (Resource Manager only): This tag denotes the IP address space for Azure including all datacenter public IP addresses. If you specify AzureCloud for the value, traffic is allowed or denied to Azure public IP addresses. If you only want to allow access to AzureCloud in a specific region, you can specify the

region. For example, if you want to allow access only to Azure AzureCloud in the East US region, you could specify AzureCloud.EastUS as a service tag.




AzureTrafficManager (Resource Manager only): This tag denotes the IP address space for the Azure Traffic Manager probe IP addresses. More information on Traffic Manager probe IP addresses can be found in the Azure Traffic Manager FAQ.




Storage (Resource Manager only): This tag denotes the IP address space for the Azure Storage service. If you specify Storage for the value, traffic is allowed or denied to storage. If you only want to allow access to storage in a specific region, you can specify the region. For example, if you want to allow access only to Azure Storage in the East US region, you could specify Storage.EastUS as a service tag. The tag represents the service, but not specific instances of the service. For example, the tag represents the Azure Storage service, but not a specific Azure Storage account. All address prefixes represented by this tag are also represented by the Internet tag.




Sql (Resource Manager only): This tag denotes the address prefixes of the Azure SQL Database, Azure Database for MySQL, Azure Database for PostgreSQL, and Azure SQL Data Warehouse services. If you specify Sql for the value, traffic is allowed or denied to Sql. If you only want to allow access to Sql in a specific region, you can specify the region. For example, if you want to allow access only to Azure SQL Database in the East US region, you could specify Sql.EastUS as a service tag. The tag represents the service, but not specific instances of the service. For example, the tag represents the Azure SQL Database service, but not a specific SQL database or server. All address prefixes represented by this tag are also represented by the Internet tag.




AzureCosmosDB (Resource Manager only): This tag denotes the address prefixes of the Azure Cosmos Database service. If you specify AzureCosmosDB for the value, traffic is allowed or denied to AzureCosmosDB. If you only want to allow access to AzureCosmosDB in a specific region, you can specify the region in the following format AzureCosmosDB.[region name].




AzureKeyVault (Resource Manager only): This tag denotes the address prefixes of the Azure KeyVault service. If you specify AzureKeyVault for the value, traffic is allowed or denied to AzureKeyVault. If you only want to allow access to AzureKeyVault in a specific region, you can specify the region in the following format AzureKeyVault.[region name].




EventHub (Resource Manager only): This tag denotes the address prefixes of the Azure EventHub service. If you specify EventHub for the value, traffic is allowed or denied to EventHub. If you only want to allow access to EventHub in a specific region, you can specify the region in the following format EventHub.[region name].




ServiceBus (Resource Manager only): This tag denotes the address prefixes of the Azure ServiceBus service using the Premium service tier. If you specify ServiceBus for the value, traffic is allowed or denied to ServiceBus. If you only want to allow access to ServiceBus in a specific region, you can specify the region in

the following format ServiceBus.[region name].




MicrosoftContainerRegistry (Resource Manager only): This tag denotes the address prefixes of the Microsoft Container Registry service. If you specify MicrosoftContainerRegistry for the value, traffic is allowed or denied to MicrosoftContainerRegistry. If you only want to allow access to MicrosoftContainerRegistry in a specific region, you can specify the region in the following formatMicrosoftContainerRegistry.[region name].




AzureContainerRegistry (Resource Manager only): This tag denotes the address prefixes of the Azure Container Registry service. If you specify AzureContainerRegistry for the value, traffic is allowed or denied to AzureContainerRegistry. If you only want to allow access to AzureContainerRegistry in a specific region, you can specify the region in the following format

AzureContainerRegistry.[region name].




AppService (Resource Manager only): This tag denotes the address prefixes of the Azure AppService service. If you specify AppService for the value, traffic is allowed or denied to AppService. If you only want to allow access to AppService in a specific region, you can specify the region in the following format AppService.[region name].




AppServiceManagement (Resource Manager only): This tag denotes the address prefixes of the Azure AppService Management service. If you specify AppServiceManagement for the value, traffic is allowed or denied to AppServiceManagement.




ApiManagement (Resource Manager only): This tag denotes the address prefixes of the Azure Api Management service. If you specify ApiManagement for the value, traffic is allowed or denied to ApiManagement.




AzureConnectors (Resource Manager only): This tag denotes the address prefixes of the Azure Connectors service. If you specify AzureConnectors for the value, traffic is allowed or denied to AzureConnectors. If you only want to allow access to AzureConnectors in a specific region, you can specify the region in the following format AzureConnectors.[region name].




GatewayManager (Resource Manager only): This tag denotes the address prefixes of the Azure Gateway Manager service. If you specify GatewayManager for the value, traffic is allowed or denied to GatewayManager.




AzureDataLake (Resource Manager only): This tag denotes the address prefixes of the Azure Data Lake service. If you specify AzureDataLake for the value, traffic is allowed or denied to AzureDataLake.




AzureActiveDirectory (Resource Manager only): This tag denotes the address prefixes of the AzureActiveDirectory service. If you specify AzureActiveDirectory for the value, traffic is allowed or denied to AzureActiveDirectory.




AzureMonitor (Resource Manager only): This tag denotes the address prefixes of the AzureMonitor service. If you specify AzureMonitor for the value, traffic is allowed or denied to AzureMonitor.




ServiceFabric (Resource Manager only): This tag denotes the address prefixes of the ServiceFabric service. If you specify ServiceFabric for the value, traffic is allowed or denied to ServiceFabric.




AzureMachineLearning (Resource Manager only): This tag denotes the address prefixes of the AzureMachineLearning service. If you specify AzureMachineLearning for the value, traffic is allowed or denied to AzureMachineLearning.







Default security rules

Azure creates the following default rules in each network security group that you create:




Inbound

AllowVNetInBound




PRIORITY SOURCE SOURCEPORTS DESTINATION PORTS PROTOCOL ACCESS

65000 VirtualNetwork 0-65535 VirtualNetwork 0-65535 All Allow




AllowAzureLoadBalancerInBound

PRIORITY SOURCE SOURCEPORTS DESTINATION PORTS PROTOCOL ACCESS

65001 AzureLoadBalancer 0-65535 0.0.0.0/0 0-65535 All Allow




DenyAllInbound

PRIORITY SOURCE SOURCEPORTS DESTINATION PORTS PROTOCOL ACCESS

65500 0.0.0.0/0 0-65535 0.0.0.0/0 0-65535 All Deny




Outbound

AllowVnetOutBound

PRIORITY SOURCE SOURCEPORTS DESTINATION PORTS PROTOCOL ACCESS

65000 VirtualNetwork0-65535 VirtualNetwork 0-65535 All Allow




AllowInternetOutBound

PRIORITY SOURCE SOURCEPORTS DESTINATION PORTS PROTOCOL ACCESS

65001 0.0.0.0/0 0-65535 Internet 0-65535 All Allow




DenyAllOutBound

PRIORITY SOURCE SOURCEPORTS DESTINATION PORTS PROTOCOL ACCESS

65500 0.0.0.0/0 0-65535 0.0.0.0/0 0-65535 All Deny




In the Source and Destination columns, VirtualNetwork, AzureLoadBalancer, and Internet are service tags, rather than IP addresses. In the protocol column, All encompasses TCP, UDP, and ICMP. When creating a rule, you can specify TCP, UDP, or All, but you cannot specify ICMP alone. Therefore, if your rule requires ICMP,

select All for protocol. 0.0.0.0/0 in the Source and Destination columns represents all addresses. Clients like Azure portal, Azure CLI, or Powershell can use * or any for this expression. You cannot remove the default rules, but you can override them by creating rules with higher priorities.




Application security groups

Application security groups enable you to configure network security as a natural extension of an application's structure, allowing you to group virtual machines and define network security policies based on those groups. You can reuse your security policy at scale without manual maintenance of explicit IP addresses. The platform handles the complexity of explicit IP addresses and multiple rule sets, allowing you to focus on your business logic.




Application security groups have the following constraints:

- There are limits to the number of application security groups you can have in a subscription, as well as other limits related to application security groups. For details, see Azure limits.

- You can specify one application security group as the source and destination in a security rule. You cannot specify multiple application security groups in the source or destination.

- All network interfaces assigned to an application security group have to exist in the same virtual network that the first network interface assigned to the application security group is in. For example, if the first network interface assigned to an application security group named AsgWeb is in the virtual network named VNet1, then all subsequent network interfaces assigned to ASGWeb must exist in VNet1. You cannot add network interfaces from different virtual networks to the same application security group.




- If you specify an application security group as the source and destination in a security rule, the network interfaces in both application security groups must exist in the same virtual network. For example, if AsgLogic contained network interfaces from VNet1, and AsgDb contained network interfaces from VNet2, you could not assign AsgLogic as the source and AsgDb as the destination in a rule. All network interfaces for both the source and destination application security groups need to exist in the same virtual network.

How traffic is evaluated

You can deploy resources from several Azure services into an Azure virtual network.




You can associate zero, or one, network security group to each virtual network subnet and network interface in a virtual machine. The same network security group can be associated to as many subnets and network interfaces as you choose. The following picture illustrates different scenarios for how network security groups might be deployed to allow network traffic to and from the internet over TCP port 80:

Internet
HTTP (TCP port 80)
NSGI
NSG2
:Network
: iinterface
VMI
VM2
N SG
VM3
Subnet2
VM4
Subneé
Virtual network
eference the previous picture, along with the following text, to understand how Azure processes inbound and

outbound rules for network security groups:




Inbound traffic

For inbound traffic, Azure processes the rules in a network security group associated to a subnet first, if there is one, and then the rules in a network security group associated to the network interface, if there is one.



VM1: The security rules in NSG1 are processed, since it is associated to Subnet1 and VM1 is in Subnet1. Unless you've created a rule that allows port 80 inbound, the traffic is denied by the DenyAllInbound default security rule, and never evaluated by NSG2, since NSG2 is associated to the network interface. If NSG1 has a security rule that allows port 80, the traffic is then processed by NSG2. To allow port 80 to the virtual machine, both NSG1 and NSG2 must have a rule that allows port 80 from the internet.



VM2: The rules in NSG1 are processed because VM2 is also in Subnet1. Since VM2 does not have a network security group associated to its network interface, it receives all traffic allowed through NSG1 or is denied all traffic denied by NSG1. Traffic is either allowed or denied to all resources in the same subnet when a network security group is associated to a subnet.



VM3: Since there is no network security group associated to Subnet2, traffic is allowed into the subnet and processed by NSG2, because NSG2 is associated to the network interface attached to VM3.



VM4: Traffic is allowed to VM4, because a network security group isn't associated to Subnet3, or the network interface in the virtual machine. All network traffic is allowed through a subnet and network interface if they don't have a network security group associated to them.




Outbound traffic

For outbound traffic, Azure processes the rules in a network security group associated to a network interface first, if there is one, and then the rules in a network security group associated to the subnet, if there is one.




VM1: The security rules in NSG2 are processed. Unless you create a security rule that denies port 80 outbound to the internet, the traffic is allowed by the AllowInternetOutbound default security rule in both NSG1 and NSG2. If NSG2 has a security rule that denies port 80, the traffic is denied, and never evaluated

by NSG1. To deny port 80 from the virtual machine, either, or both of the network security groups must have a rule that denies port 80 to the internet.




VM2: All traffic is sent through the network interface to the subnet, since the network interface attached to VM2 does not have a network security group associated to it. The rules in NSG1 are processed.




VM3: If NSG2 has a security rule that denies port 80, the traffic is denied. If NSG2 has a security rule that allows port 80, then port 80 is allowed outbound to the internet, since a network security group is not associated to Subnet2.




VM4: All network traffic is allowed from VM4, because a network security group isn't associated to the network interface attached to the virtual machine, or to Subnet3.You can easily view the aggregate rules applied to a network interface by viewing the effective security rules for a network interface. You can also use the IP flow verify capability in Azure Network Watcher to determine whether communication is allowed to or from a network interface. IP flow verify tells you whether communication is allowed or denied, and which network security rule allows or denies the traffic.




NOTE

Network security groups are associated to subnets or to virtual machines and cloud services deployed in the classic deployment model, rather than to network interfaces in the Resource Manager deployment model.




PowerShell Networking
Install-Module -Name Az -AllowClobber

Connect-AzAccount

A



Create Resource Group



New-AzResourceGroup -Name JeffsTestResourceGroup -Location 'Canada East'



Create Virtual Network

-this is kind of like a supernet which all the subnet will be placed in

$virtualnetwork = New-AzVirtualNetwork -ResourceGroupName JeffsTestResourceGroup –Location 'Canada East' -Name JeffsTestVirtualNetwork -AddressPrefix 10.0.0.0/16



Create Sub Net

$subnetConfig = Add-AzVirtualNetworkSubnetConfig -Name default -AddressPrefix 10.0.0.0/24 -VirtualNetwork $virtualnetwork



$virtualnetwork | Set-AzVirtualNetwork





New-AzVm -ResourceGroupName JeffsTestResourceGroup -Location 'Canada East' -VirtualNetworkName JeffsTestVirtualNetwork -SubnetName "default" -Name "azPC1" -AsJob

New-AzVm -ResourceGroupName JeffsTestResourceGroup -Location 'Canada East' -VirtualNetworkName JeffsTestVirtualNetwork -SubnetName "default"-Name "azPC2"

Get-AzPublicIpAddress -Name azPC1 -ResourceGroupName JeffsTestResourceGroup

(Get-AzResourceGroup -Name JeffsTestResourceGroup).Tags





$virtualnetwork = New-AzVirtualNetwork -ResourceGroupName JeffsTestResourceGroup -Location 'Canada East' -Name DELMEJeffsTestVirtualNetwork -AddressPrefix 10.0.1.0/24 -Tag @{"Owner"="Jeff"}



ADSI C# coding



https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices?view=netframework-4.8

https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.accountmanagement?view=netframework-4.8

https://auth0.com/blog/using-ldap-with-c-sharp/

https://www.c-sharpcorner.com/article/accessing-the-active-directory-from-microsoft-net/

https://www.codemag.com/Article/1312041/Using-Active-Directory-in-.NET




